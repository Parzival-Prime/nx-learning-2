generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

enum productStatus {
  Active
  Pending
  Draft
}

model image {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  file_id String
  url     String

  userId    String? @db.ObjectId
  shopId    String? @db.ObjectId
  productId String? @db.ObjectId

  user    user?    @relation("UserAvatar", fields: [userId], references: [id])
  shop    shop?    @relation("ShopLogo", fields: [shopId], references: [id])
  product product? @relation("ProductImages", fields: [productId], references: [id])

  createdAt DateTime @default(now())
}

model user {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name     String
  email    String   @unique
  password String?
  avatar   image[]  @relation("UserAvatar")

  following ShopFollower[]
  addresses Address[]
  reviews shopReview[]
  orders orders[]

    // ðŸ”” Notification relations
  createdNotifications  Notification[] @relation("CreatedNotifications")
  receivedNotifications Notification[] @relation("ReceivedNotifications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model shopReview {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  rating Float
  review String?

  userId String @db.ObjectId
  user   user   @relation(fields: [userId], references: [id])
  shopId String @db.ObjectId
  shop   shop   @relation(fields: [shopId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model ShopFollower {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  shopId String @db.ObjectId
  userId String @db.ObjectId

  shop shop @relation(fields: [shopId], references: [id])
  user user @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([shopId, userId]) // prevents duplicate follows
}



model shop {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name         String
  description  String?
  category     String
  logo         image[] @relation("ShopLogo")
  coverBanner  String?
  address      String
  openingHours String?
  website      String?
  products     product[]
  socialLinks  Json[]
  ratings      Float @default(0)
  reviews      shopReview[]
  seller       seller?
  orders       orders[]

  followers    ShopFollower[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model seller {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  name         String
  email        String  @unique
  phone_number String
  country      String
  password     String
  stripeId     String?

  shopId String? @unique @db.ObjectId
  shop   shop?   @relation(fields: [shopId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model site_config {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  categories    String[]
  subCategories Json
}

model discount_codes {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  public_name   String
  discountType  String
  discountValue Float
  discountCode  String @unique
  sellerId      String @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model product {
  id                    String        @id @default(auto()) @map("_id") @db.ObjectId
  title                 String
  slug                  String        @unique
  category              String
  subCategory           String
  short_description     String
  detailed_description  String
  images                image[]       @relation("ProductImages")
  video_url             String?
  tags                  String[]
  brand                 String?
  colors                String[]
  sizes                 String[]
  isEvent               Boolean @default(false)
  starting_date         DateTime?
  ending_date           DateTime?
  stock                 Int
  sale_price            Float
  regular_price         Float
  ratings               Float         @default(5)
  warranty              String?
  custom_specifications Json?
  custom_properties     Json
  isDeleted             Boolean?      @default(false)
  cashOnDelivery        String?
  discount_codes        String[]      @db.ObjectId
  totalSales            Int           @default(0)
  status                productStatus @default(Active)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  shopId String @db.ObjectId
  shop   shop   @relation(fields: [shopId], references: [id])
  orderItems orderItem[]
}

model UserAnalytics {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @unique

  actions     Json     // stores product interactions
  lastVisited DateTime

  country     String?
  city        String?
  device      String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProductAnalytics {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  productId      String   @unique
  shopId         String?

  views          Int      @default(0)
  cartAdds       Int      @default(0)
  wishListAdds   Int      @default(0)
  purchases      Int      @default(0)

  lastViewedAt   DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}


model orders {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // ðŸ”— Relations
  userId String @db.ObjectId
  user   user   @relation(fields: [userId], references: [id])

  shopId String @db.ObjectId
  shop   shop   @relation(fields: [shopId], references: [id])

  // ðŸ’° Order data
  total  Float
  status String @default("Pending") // Paid | Pending | Cancelled | Refunded

  // ðŸ“¦ Shipping & discounts
  shippingAddressId String? @db.ObjectId
  couponCode        String?  // amount discounted
  deliveryStatus    String @default("Ordered")

  // ðŸ§º Items in this order
  items orderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([shopId])
}


model orderItem {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  orderId String @db.ObjectId
  order   orders @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String @db.ObjectId
  product   product @relation(fields: [productId], references: [id])

  quantity Int
  price    Float

  selectedOptions Json?

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}



model Address {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId 

  label     String
  name      String
  street    String
  city      String
  zip       String
  country   String

  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String  @db.ObjectId
  user user @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


model Notification {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  title         String
  message       String
  redirect_link String?

  creatorId     String @db.ObjectId
  receiverId    String @db.ObjectId

  isRead        Boolean  @default(false)
  createdAt     DateTime @default(now())

  creator  user @relation("CreatedNotifications", fields: [creatorId], references: [id])
  receiver user @relation("ReceivedNotifications", fields: [receiverId], references: [id])

  @@index([receiverId])
}
